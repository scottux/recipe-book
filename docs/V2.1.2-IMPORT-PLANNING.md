# V2.1.2 - Import from Backup - Planning Document

**Feature**: Import from Backup  
**Version**: 2.1.2  
**Status**: Phase 1 - Planning Complete  
**Date**: February 15, 2026

---

## Executive Summary

This feature enables users to import previously exported JSON backup files back into the Recipe Book application. It complements the existing full backup export feature (V2.0) and provides data portability, recovery, and migration capabilities.

---

## Goals

### Primary Goals
1. **Data Recovery**: Allow users to restore data from backups
2. **Data Migration**: Enable moving data between accounts/instances
3. **Data Merging**: Support importing data without losing existing data
4. **Data Validation**: Ensure imported data meets quality standards
5. **Conflict Resolution**: Handle duplicate/conflicting data gracefully

### Success Criteria
- Users can successfully import V2.0 backup files
- Import validation catches 100% of malformed data
- Merge vs. replace options work correctly
- No data loss during import process
- Clear error messages for import failures
- Import completes within reasonable time (< 30 seconds for typical backups)

---

## Analysis of Existing Export System

### Export Format (V2.0)

```json
{
  "version": "2.0",
  "exportDate": "2026-02-15T20:44:00.000Z",
  "user": {
    "username": "string",
    "email": "string",
    "createdAt": "ISO date"
  },
  "statistics": {
    "totalRecipes": number,
    "totalCollections": number,
    "totalMealPlans": number,
    "totalShoppingLists": number
  },
  "recipes": [ /* Recipe objects */ ],
  "collections": [ /* Collection objects */ ],
  "mealPlans": [ /* MealPlan objects */ ],
  "shoppingLists": [ /* ShoppingList objects */ ]
}
```

### Data Structures

**Recipe:**
- id, title, description, ingredients[], instructions[]
- prepTime, cookTime, servings, difficulty, cuisine, dishType
- tags[], notes, sourceUrl, imageUrl, rating
- isLocked, createdAt, updatedAt

**Collection:**
- id, name, description, icon, isPublic
- recipeIds[] (references)
- createdAt, updatedAt

**MealPlan:**
- id, name, startDate, endDate, isTemplate
- meals[] with date, mealType, recipes[] (with recipeId, servings), notes
- createdAt, updatedAt

**Shopping List:**
- id, name, items[] (ingredient, quantity, unit, category, checked, recipeId, notes, isCustom)
- mealPlanId, isActive, completedAt
- createdAt, updatedAt

---

## Import Requirements

### Functional Requirements

#### FR-1: File Upload & Validation
- Accept JSON files up to 50MB
- Validate JSON structure matches V2.0 format
- Check version compatibility
- Validate required fields exist
- Validate data types and constraints

#### FR-2: Import Modes
1. **Replace Mode**: Delete all existing data, import fresh
2. **Merge Mode**: Keep existing data, add imported data
3. **Smart Merge**: Merge with conflict resolution (V2.1.2 initial: skip, future: UI-based resolution)

#### FR-3: Data Mapping
- Map imported IDs to new database IDs
- Maintain relationships between entities
- Preserve recipe references in collections
- Preserve recipe references in meal plans
- Handle recipe references in shopping lists

#### FR-4: Conflict Detection
- Detect duplicate recipes (by title + ingredients hash)
- Detect duplicate collections (by name)
- Detect duplicate meal plans (by name + date range)
- Handle conflicts based on import mode

#### FR-5: Validation Rules
- Recipes: Require title, ingredients, instructions
- Collections: Require name, validate recipe references
- Meal Plans: Require name, dates, validate recipe references
- Shopping Lists: Require name, validate item structure

#### FR-6: Progress Tracking
- Track import progress (recipes, collections, meal plans, shopping lists)
- Provide import summary (created, skipped, errors)
- Log detailed errors for troubleshooting

### Non-Functional Requirements

#### NFR-1: Security
- Authenticate user before import
- Validate file size limits (50MB max)
- Sanitize all imported data
- Prevent code injection
- Rate limit import operations (max 5 imports/hour)

#### NFR-2: Performance
- Process typical backup (100 recipes) in < 10 seconds
- Process large backup (1000 recipes) in < 30 seconds
- Use transaction for atomic operations
- Provide progress updates for long imports

#### NFR-3: Data Integrity
- Use database transactions
- Rollback on any error
- Validate all references before creating
- Ensure referential integrity

#### NFR-4: Usability
- Clear UI for file selection
- Progress indicator during import
- Detailed summary after import
- Clear error messages with actionable steps

---

## Data Validation Strategy

### Validation Layers

**Layer 1: File Validation**
- File exists and is readable
- File size within limits
- Valid JSON format
- Contains required top-level fields (version, exportDate)

**Layer 2: Schema Validation**
- Version matches supported versions (2.0)
- All required sections present
- Data types match expected types
- Arrays contain expected object structures

**Layer 3: Business Logic Validation**
- Recipe ingredients not empty
- Recipe instructions not empty
- Collection names unique (within import)
- Meal plan dates valid
- Shopping list items valid

**Layer 4: Reference Validation**
- Collection recipe IDs exist in import
- Meal plan recipe IDs exist in import
- Shopping list recipe IDs exist in import (if not custom)

**Layer 5: Database Constraints**
- Check against database schema
- Ensure referential integrity
- Validate unique constraints

---

## Import Strategies

### Strategy 1: Replace Mode (V2.1.2)

**Process:**
1. Validate backup file
2. Start transaction
3. Delete all user's existing data
4. Import all data from backup
5. Create ID mappings
6. Update all references
7. Commit transaction
8. Return summary

**Pros:**
- Simple implementation
- Clean slate
- No conflicts

**Cons:**
- Destructive (loses current data)
- No way to recover if user didn't intend full replace

**Safeguards:**
- Require explicit confirmation
- Create automatic backup before replace
- Show clear warning message

### Strategy 2: Merge Mode (V2.1.2)

**Process:**
1. Validate backup file
2. Start transaction
3. Import recipes (skip if duplicate detected)
4. Import collections (skip if duplicate detected)
5. Import meal plans (skip if duplicate detected)
6. Import shopping lists (skip if duplicate detected)
7. Create ID mappings
8. Update all references
9. Commit transaction
10. Return summary (created, skipped)

**Duplicate Detection:**
- Recipes: Title + first 3 ingredients match
- Collections: Exact name match
- Meal Plans: Name + overlapping dates
- Shopping Lists: Name match

**Pros:**
- Non-destructive
- Preserves existing data
- Safe default behavior

**Cons:**
- May create genuine duplicates if user wants them
- Conflict resolution is automated (no user choice)

### Strategy 3: Smart Merge (Future V2.1.3+)

**Process:**
1. Validate backup file
2. Detect all conflicts
3. Present conflicts to user
4. User chooses action per conflict (keep existing, use imported, create both)
5. Execute import based on user choices

**Deferred to Future:**
- Requires complex UI
- Requires conflict resolution interface
- Can be added in V2.1.3+

---

## Merge vs. Replace Decision Matrix

| Scenario | Replace Mode | Merge Mode | Recommendation |
|----------|--------------|------------|----------------|
| Recovery after data loss | ✅ Ideal | ⚠️ Won't restore lost data | Replace |
| Migration to new account | ✅ Clean import | ⚠️ If account empty | Replace |
| Importing backup with new recipes | ❌ Loses current recipes | ✅ Keeps both | Merge |
| Testing import feature | ✅ Repeatable | ⚠️ Creates duplicates | Replace (test account) |
| Selective data import | ❌ All or nothing | ⚠️ Limited control | Merge (future: selective) |

**Default**: Merge Mode (safer, non-destructive)

---

## Security Considerations

### Threats

1. **Malicious JSON**: Crafted JSON to exploit parser
2. **Code Injection**: Embedded code in strings
3. **Resource Exhaustion**: Huge files causing DoS
4. **Data Pollution**: Importing malicious content
5. **Unauthorized Access**: Importing someone else's backup

### Mitigations

1. **File Size Limits**: 50MB maximum
2. **Input Sanitization**: Clean all string inputs
3. **Rate Limiting**: 5 imports per hour per user
4. **Validation**: Strict schema validation
5. **Authentication**: Require valid session
6. **Sandboxing**: Process imports in isolated context
7. **Transaction Rollback**: Rollback on any error

---

## API Design

### POST /api/import/backup

**Purpose**: Import full backup file

**Authentication**: Required

**Request:**
- Content-Type: multipart/form-data
- Body: 
  - file: JSON backup file
  - mode: "replace" | "merge" (optional, default: "merge")
  - confirmReplace: boolean (required if mode=replace)

**Response Success (200):**
```json
{
  "success": true,
  "summary": {
    "mode": "merge",
    "importDate": "2026-02-15T20:44:00.000Z",
    "duration": "8.5s",
    "recipes": {
      "imported": 45,
      "skipped": 5,
      "total": 50
    },
    "collections": {
      "imported": 8,
      "skipped": 2,
      "total": 10
    },
    "mealPlans": {
      "imported": 3,
      "skipped": 0,
      "total": 3
    },
    "shoppingLists": {
      "imported": 2,
      "skipped": 1,
      "total": 3
    }
  },
  "warnings": [
    "5 recipes skipped due to duplicates",
    "2 collections skipped due to name conflicts"
  ]
}
```

**Response Error (400/500):**
```json
{
  "success": false,
  "error": "Validation failed",
  "details": [
    "Recipe 'Pasta Carbonara' missing required field: instructions",
    "Collection 'Italian Classics' references non-existent recipe ID: abc123"
  ]
}
```

**Rate Limit**: 5 requests per hour per user

---

## Frontend UI Design

### Import Page (/import)

**Components:**
1. **File Upload Zone**
   - Drag & drop area
   - File picker button
   - File size/type validation
   - Preview of selected file

2. **Import Mode Selector**
   - Radio buttons: Merge (default) vs. Replace
   - Clear explanation of each mode
   - Warning for Replace mode

3. **Import Options**
   - Checkbox: "Create backup before import" (default: checked)
   - Confirmation checkbox for Replace mode

4. **Progress Indicator**
   - Upload progress bar
   - Processing status (validating, importing, finalizing)
   - Current step indicator

5. **Results Summary**
   - Success/failure status
   - Detailed statistics
   - List of warnings/errors
   - Link to view imported data

### Error Handling UI
- Clear error messages
- Suggestions for fixing errors
- Option to download error log
- Link to help documentation

---

## Implementation Plan

### Phase 2: Requirements Documentation
- Create REQ-016-import-from-backup.md (600+ lines)
- Detail all user stories
- Specify API contracts
- Define validation rules
- Document error scenarios

### Phase 3: Design & Architecture
- Design import controller
- Plan validation pipeline
- Design ID mapping strategy
- Plan transaction management
- Design progress tracking

### Phase 4: Implementation
- Backend: Import controller + routes
- Backend: Validation service
- Backend: ID mapping service
- Frontend: Import page component
- Frontend: File upload component
- Frontend: Progress display

### Phase 5: Testing
- Integration tests (15+)
- Validation tests
- Security tests
- Performance tests
- Error scenario tests

### Phase 6: Code Review
- Security review
- Performance review
- Code quality review
- Documentation review

### Phase 7: Release
- API documentation
- Feature documentation
- User guide
- CHANGELOG update
- Release notes

---

## Testing Strategy

### Test Categories

**Happy Path (30%)**
- Import valid backup (merge mode)
- Import valid backup (replace mode)
- Import empty backup
- Import single recipe

**Error Handling (40%)**
- Invalid JSON format
- Missing required fields
- Invalid data types
- Broken references
- Duplicate detection
- File too large
- Unsupported version

**Edge Cases (20%)**
- Import with 0 recipes
- Import with 1000+ recipes
- Import with circular references
- Import with special characters
- Import with very long strings

**Security (10%)**
- Rate limiting test
- File size limit test
- Authentication test
- Input sanitization test
- Transaction rollback test

---

## Risks & Mitigation

### Risk 1: Data Loss During Import
**Mitigation:**
- Use database transactions
- Automatic backup before replace mode
- Rollback on any error
- Extensive testing

### Risk 2: Poor Performance on Large Imports
**Mitigation:**
- Batch processing
- Progress tracking
- Optimize database operations
- Set reasonable timeouts

### Risk 3: Complex Conflict Resolution
**Mitigation:**
- Start with simple skip strategy (V2.1.2)
- Document known limitations
- Plan UI-based resolution for V2.1.3+

### Risk 4: Security Vulnerabilities
**Mitigation:**
- Strict input validation
- Rate limiting
- File size limits
- Input sanitization
- Security testing

---

## Future Enhancements (V2.1.3+)

1. **Selective Import**: Choose which data types to import
2. **Smart Conflict Resolution**: UI for handling conflicts
3. **Import from URL**: Import backup from cloud storage
4. **Scheduled Imports**: Automatic sync with cloud backup
5. **Import History**: Track all imports with rollback capability
6. **Partial Import**: Import specific recipes/collections
7. **Import Validation Report**: Pre-import analysis

---

## Dependencies

### Technical Dependencies
- Existing models: Recipe, Collection, MealPlan, ShoppingList
- Database transactions (MongoDB)
- File upload handling (multer)
- JSON validation library

### Feature Dependencies
- Export feature (V2.0) - defines format
- Authentication (V2.0) - required for security

### No Blocking Dependencies
- Can be implemented independently
- Doesn't block other V2.1.x features

---

## Timeline Estimate

**Phase 1 - Planning**: 30 minutes ✅  
**Phase 2 - Requirements**: 2 hours  
**Phase 3 - Design**: 1 hour  
**Phase 4 - Implementation**: 4 hours  
**Phase 5 - Testing**: 2 hours  
**Phase 6 - Code Review**: 1 hour  
**Phase 7 - Documentation**: 1 hour  

**Total**: ~11.5 hours

---

## Conclusion

The Import from Backup feature is well-scoped, technically feasible, and provides high user value. The phased approach (simple merge/replace in V2.1.2, advanced conflict resolution in V2.1.3+) allows for incremental delivery while managing complexity.

**Phase 1 Status**: ✅ COMPLETE  
**Ready for Phase 2**: YES  
**Next Step**: Create REQ-016-import-from-backup.md