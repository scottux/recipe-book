# V2.3.0 - Tech Debt Sprint Planning

**Version**: 2.3.0  
**Release Type**: Patch (Tech Debt & Infrastructure)  
**Timeline**: 2 weeks  
**Target Date**: March 3, 2026  
**Status**: ðŸ“‹ Planning Phase

---

## Table of Contents

1. [Executive Summary](#executive-summary)
2. [Objectives](#objectives)
3. [Scope](#scope)
4. [Technical Approach](#technical-approach)
5. [Implementation Plan](#implementation-plan)
6. [Testing Strategy](#testing-strategy)
7. [Success Criteria](#success-criteria)
8. [Timeline](#timeline)
9. [Risk Assessment](#risk-assessment)

---

## Executive Summary

V2.3.0 is a **tech debt sprint** focused on addressing accumulated technical debt from the V2.2.x release series. This release prioritizes infrastructure improvements, testing reliability, and security updates over new features.

### Key Goals

1. **Implement CI/CD pipeline** for automated testing
2. **Improve email service testing** with reliable strategy
3. **Security audit and dependency updates**
4. **Update API documentation** for recent features
5. **Fix minor bugs and warnings**

### Rationale

The retrospective for V2.2.4 identified 8 tech debt items, with 2 critical and 3 high-priority. Addressing these now prevents accumulation and ensures a solid foundation for future feature development.

---

## Objectives

### Primary Objectives

1. **Automate Quality Gates**
   - Implement GitHub Actions CI/CD
   - Enforce test success before merge
   - Automated linting and security checks

2. **Improve Test Reliability**
   - Fix email service testing fragility
   - Implement Ethereal Email strategy
   - Add email template tests

3. **Address Security Concerns**
   - Fix nodemailer vulnerabilities
   - Upgrade happy-dom
   - Complete dependency audit

4. **Enhance Documentation**
   - Update API docs for V2.2.x features
   - Create test troubleshooting guide
   - Improve test helper documentation

5. **Fix Minor Issues**
   - Mongoose duplicate index warning
   - Other cosmetic warnings
   - Pre-commit hooks

### Secondary Objectives

- Establish monthly dependency audit process
- Document CI/CD maintenance procedures
- Create email testing best practices guide

---

## Scope

### In Scope âœ…

#### 1. CI/CD Pipeline Implementation
- GitHub Actions workflow files
- Lint workflow (ESLint, Prettier)
- Test workflow (unit + integration)
- Security scanning workflow
- Branch protection rules
- Status check requirements

#### 2. Email Service Testing
- Ethereal Email integration
- Email template snapshot tests
- Updated email integration tests
- Email testing documentation
- Mock service removal (where possible)

#### 3. Security & Dependencies
- `npm audit` full report
- nodemailer upgrade/fix
- happy-dom upgrade (with tests)
- All dependencies reviewed and updated
- Security scanning in CI/CD

#### 4. Documentation Updates
- API docs for cloud backup endpoints
- API docs for import endpoints
- Test troubleshooting guide
- Test helper usage examples
- CI/CD maintenance guide

#### 5. Bug Fixes
- Mongoose duplicate index warning
- Any warnings in test output
- Pre-commit hook setup (husky + lint-staged)

### Out of Scope âŒ

- New features
- Frontend test coverage (deferred to V2.4.0)
- Performance optimization (deferred to V2.5.0)
- Code refactoring (deferred to V2.5.0)
- E2E test updates (deferred to V2.4.0)

---

## Technical Approach

### 1. CI/CD Pipeline Architecture

```yaml
# .github/workflows/ci.yml
name: Continuous Integration

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install Dependencies
        run: |
          cd recipe-book/backend && npm ci
          cd ../frontend && npm ci
      - name: Run ESLint (Backend)
        run: cd recipe-book/backend && npm run lint
      - name: Run ESLint (Frontend)
        run: cd recipe-book/frontend && npm run lint
      - name: Check Formatting
        run: |
          cd recipe-book/backend && npm run format:check
          cd ../frontend && npm run format:check

  test-backend:
    name: Backend Tests
    runs-on: ubuntu-latest
    services:
      mongodb:
        image: mongo:7
        env:
          MONGO_INITDB_ROOT_USERNAME: testuser
          MONGO_INITDB_ROOT_PASSWORD: testpass
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand({ping:1})'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install Dependencies
        run: cd recipe-book/backend && npm ci
      - name: Run Tests
        run: cd recipe-book/backend && npm test
        env:
          MONGODB_URI: mongodb://testuser:testpass@localhost:27017/recipe-book-test?authSource=admin
          JWT_SECRET: test-secret-for-ci
          NODE_ENV: test
      - name: Upload Coverage
        uses: codecov/codecov-action@v3
        with:
          files: recipe-book/backend/coverage/lcov.info
          flags: backend

  test-frontend:
    name: Frontend Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install Dependencies
        run: cd recipe-book/frontend && npm ci
      - name: Run Tests
        run: cd recipe-book/frontend && npm test
      - name: Upload Coverage
        uses: codecov/codecov-action@v3
        with:
          files: recipe-book/frontend/coverage/lcov.info
          flags: frontend

  security:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '20'
      - name: Audit Backend
        run: cd recipe-book/backend && npm audit --audit-level=high
      - name: Audit Frontend
        run: cd recipe-book/frontend && npm audit --audit-level=high
```

**Branch Protection Rules**:
```yaml
# Configure in GitHub Settings
main branch:
  - Require pull request before merging
  - Require status checks to pass:
    - lint
    - test-backend
    - test-frontend
    - security
  - Require conversation resolution
  - Require linear history
  - Include administrators
```

---

### 2. Email Testing Strategy

#### Current Problem
```javascript
// Current approach (fragile)
jest.mock('nodemailer', () => ({
  createTransport: jest.fn(() => ({
    sendMail: jest.fn().mockResolvedValue({ messageId: 'test' })
  }))
}));
```

**Issues**:
- Doesn't test actual email generation
- Can't verify email content
- No template testing
- Fragile mocking

#### New Approach: Ethereal Email

```javascript
// emailService.js
const nodemailer = require('nodemailer');

// Create test account for testing
async function createTestTransporter() {
  const testAccount = await nodemailer.createTestAccount();
  return nodemailer.createTransport({
    host: 'smtp.ethereal.email',
    port: 587,
    secure: false,
    auth: {
      user: testAccount.user,
      pass: testAccount.pass
    }
  });
}

// Use in tests
const transporter = await createTestTransporter();
const info = await transporter.sendMail(options);
console.log('Preview URL: %s', nodemailer.getTestMessageUrl(info));

// Can now test:
// 1. Email is actually sent
// 2. Email content is correct
// 3. Templates render properly
// 4. Can view emails at ethereal.email
```

#### Email Template Testing

```javascript
// __tests__/templates/email-templates.test.js
const fs = require('fs');
const path = require('path');

describe('Email Templates', () => {
  it('should render password reset email correctly', () => {
    const template = fs.readFileSync(
      path.join(__dirname, '../../templates/email/password-reset.html'),
      'utf8'
    );
    
    const rendered = template
      .replace('{{resetToken}}', 'TEST123')
      .replace('{{username}}', 'testuser');
    
    expect(rendered).toContain('TEST123');
    expect(rendered).toContain('testuser');
    expect(rendered).toContain('Reset Password');
  });
  
  // Snapshot test for template structure
  it('should match snapshot for password reset template', () => {
    const template = fs.readFileSync(
      path.join(__dirname, '../../templates/email/password-reset.html'),
      'utf8'
    );
    expect(template).toMatchSnapshot();
  });
});
```

---

### 3. Dependency Update Strategy

#### Process

1. **Audit Current State**
   ```bash
   cd recipe-book/backend
   npm audit
   npm outdated
   
   cd ../frontend
   npm audit
   npm outdated
   ```

2. **Categorize Updates**
   - **Critical**: Security vulnerabilities (fix immediately)
   - **High**: Major version updates with breaking changes
   - **Medium**: Minor/patch updates (likely safe)
   - **Low**: Dev dependencies

3. **Update Process**
   ```bash
   # Test each update in isolation
   npm update packagename --save
   npm test
   
   # If tests pass, commit
   git add package*.json
   git commit -m "chore: update packagename to vX.Y.Z"
   
   # If tests fail, investigate breaking changes
   ```

4. **Known Issues**

   **nodemailer**:
   - Current: v6.x.x (has vulnerabilities)
   - Target: v7.x.x
   - Breaking Changes: Review changelog
   - Testing: Use Ethereal Email to verify

   **happy-dom**:
   - Current: v12.x.x
   - Target: v14.x.x (or latest)
   - Breaking Changes: API changes in testing
   - Testing: Run full frontend test suite

---

### 4. Documentation Updates

#### API Documentation Structure

```markdown
# Cloud Backup API

## Endpoints

### POST /api/cloud/google-drive/auth
Authenticate with Google Drive

**Request**:
```json
{
  "authCode": "4/0AbCD123..."
}
```

**Response**:
```json
{
  "success": true,
  "message": "Successfully connected to Google Drive",
  "user": {
    "cloudBackup": {
      "googleDrive": {
        "connected": true,
        "email": "user@gmail.com"
      }
    }
  }
}
```

[Continue for all endpoints...]
```

---

## Implementation Plan

### Phase 1: CI/CD Setup (3 days)

#### Day 1: Workflow Creation
- [ ] Create `.github/workflows/` directory
- [ ] Create `ci.yml` workflow file
- [ ] Configure lint job
- [ ] Configure test jobs (backend/frontend)
- [ ] Configure security audit job
- [ ] Test on feature branch

#### Day 2: Branch Protection
- [ ] Configure main branch protection
- [ ] Add required status checks
- [ ] Test workflow on PR
- [ ] Document CI/CD process
- [ ] Create troubleshooting guide

#### Day 3: Integration & Testing
- [ ] Test full workflow end-to-end
- [ ] Verify coverage reporting
- [ ] Fix any workflow issues
- [ ] Update README with CI badge
- [ ] Document for team

**Deliverables**:
- âœ… Functional CI/CD pipeline
- âœ… Branch protection rules active
- âœ… CI/CD documentation
- âœ… Status badges in README

---

### Phase 2: Email Testing (3 days)

#### Day 1: Ethereal Email Integration
- [ ] Install/configure Ethereal Email
- [ ] Update test setup to use Ethereal
- [ ] Convert existing email tests
- [ ] Verify email content in tests

#### Day 2: Template Testing
- [ ] Create email template test file
- [ ] Add template rendering tests
- [ ] Add snapshot tests for templates
- [ ] Test all email templates
- [ ] Verify HTML and text versions

#### Day 3: Integration Tests
- [ ] Update email verification tests
- [ ] Update password reset email tests
- [ ] Update backup failure email tests
- [ ] Update 2FA email tests
- [ ] Document email testing strategy

**Deliverables**:
- âœ… Ethereal Email configured
- âœ… All email tests using Ethereal
- âœ… Template tests with snapshots
- âœ… Email testing documentation

---

### Phase 3: Security & Dependencies (3 days)

#### Day 1: Audit & Planning
- [ ] Run `npm audit` on backend
- [ ] Run `npm audit` on frontend
- [ ] Document all vulnerabilities
- [ ] Create update plan
- [ ] Prioritize updates

#### Day 2: Critical Updates
- [ ] Fix nodemailer vulnerabilities
- [ ] Test email functionality
- [ ] Update other critical packages
- [ ] Run full test suite
- [ ] Fix any breaking changes

#### Day 3: Non-Critical Updates
- [ ] Update happy-dom
- [ ] Update dev dependencies
- [ ] Update minor/patch versions
- [ ] Run tests after each update
- [ ] Document breaking changes

**Deliverables**:
- âœ… Zero high/critical vulnerabilities
- âœ… All dependencies up-to-date
- âœ… Tests passing after updates
- âœ… Breaking changes documented

---

### Phase 4: Documentation (2 days)

#### Day 1: API Documentation
- [ ] Document cloud backup endpoints
- [ ] Document import endpoints
- [ ] Add request/response examples
- [ ] Document error responses
- [ ] Add authentication requirements

#### Day 2: Testing Documentation
- [ ] Create test troubleshooting guide
- [ ] Enhance test helper documentation
- [ ] Add email testing guide
- [ ] Document CI/CD maintenance
- [ ] Review all documentation

**Deliverables**:
- âœ… Complete API docs for V2.2.x
- âœ… Test troubleshooting guide
- âœ… Enhanced test helper docs
- âœ… CI/CD maintenance guide

---

### Phase 5: Bug Fixes & Polish (1 day)

#### Day 1: Fixes
- [ ] Fix Mongoose duplicate index warning
- [ ] Fix other test warnings
- [ ] Setup pre-commit hooks (husky)
- [ ] Configure lint-staged
- [ ] Test pre-commit flow
- [ ] Update CHANGELOG.md
- [ ] Prepare release notes

**Deliverables**:
- âœ… All warnings fixed
- âœ… Pre-commit hooks working
- âœ… CHANGELOG updated
- âœ… Release notes ready

---

## Testing Strategy

### Test Coverage Requirements

**Backend**:
- Maintain >85% coverage âœ…
- All integration tests passing
- Email tests reliable and comprehensive
- Security tests updated

**Frontend**:
- Maintain current coverage (baseline)
- No new test failures
- UI tests passing

### Test Types

1. **Unit Tests**
   - Email template rendering
   - Utility functions
   - Model validation

2. **Integration Tests**
   - Email service with Ethereal
   - API endpoints
   - Database operations

3. **CI/CD Tests**
   - Workflow execution
   - Branch protection
   - Security scanning

### Manual Testing

**Required Manual Tests**:
- [ ] CI/CD workflow on PR
- [ ] Email functionality in test environment
- [ ] View sent email at ethereal.email
- [ ] Branch protection prevents merge without checks
- [ ] Pre-commit hooks prevent bad commits

---

## Success Criteria

### Must Have âœ…

1. **CI/CD Pipeline**
   - [ ] GitHub Actions workflows functional
   - [ ] All tests run automatically on PR
   - [ ] Branch protection enforced
   - [ ] Status badges in README

2. **Email Testing**
   - [ ] Ethereal Email working in tests
   - [ ] All email tests passing reliably
   - [ ] Template tests with snapshots
   - [ ] Email testing documented

3. **Security**
   - [ ] Zero high/critical vulnerabilities
   - [ ] nodemailer updated and working
   - [ ] happy-dom updated and tested
   - [ ] Security scanning in CI/CD

4. **Documentation**
   - [ ] API docs complete for V2.2.x
   - [ ] Test troubleshooting guide
   - [ ] CI/CD documentation
   - [ ] Email testing guide

5. **Bug Fixes**
   - [ ] Mongoose warning fixed
   - [ ] All test warnings resolved
   - [ ] Pre-commit hooks working

### Nice to Have ðŸŽ¯

- Code coverage reporting (Codecov)
- Automated dependency updates (Dependabot)
- Performance monitoring in CI/CD
- Visual regression testing setup

---

## Timeline

### Week 1 (Feb 17-21)

**Monday-Tuesday**: CI/CD Setup
- Create workflows
- Configure branch protection
- Test integration

**Wednesday-Friday**: Email Testing
- Ethereal Email integration
- Template testing
- Integration test updates

### Week 2 (Feb 24-28)

**Monday-Wednesday**: Security & Dependencies
- Audit dependencies
- Critical updates
- Non-critical updates

**Thursday**: Documentation
- API docs
- Testing docs

**Friday**: Bug Fixes & Release
- Fix warnings
- Pre-commit hooks
- Prepare release

**Target Release**: March 3, 2026

---

## Risk Assessment

### High Risk ðŸ”´

**Risk**: Dependency updates break existing functionality
**Likelihood**: Medium  
**Impact**: High  
**Mitigation**:
- Test each update in isolation
- Review breaking changes carefully
- Rollback plan ready
- Update incrementally

**Risk**: CI/CD misconfiguration blocks development
**Likelihood**: Low  
**Impact**: High  
**Mitigation**:
- Test workflows on feature branch first
- Include bypass mechanism for emergencies
- Document troubleshooting
- Admin override capability

### Medium Risk ðŸŸ¡

**Risk**: Email testing strategy doesn't work as expected
**Likelihood**: Medium  
**Impact**: Medium  
**Mitigation**:
- Prototype Ethereal Email first
- Keep existing mocks as fallback
- Gradual migration approach
- Document both strategies

**Risk**: Documentation takes longer than estimated
**Likelihood**: Medium  
**Impact**: Low  
**Mitigation**:
- Prioritize critical docs (API, CI/CD)
- Defer nice-to-have docs if needed
- Parallel work with testing phases

### Low Risk ðŸŸ¢

**Risk**: Pre-commit hooks annoy developers
**Likelihood**: Low  
**Impact**: Low  
**Mitigation**:
- Make hooks fast (<5 seconds)
- Allow bypass with --no-verify (documented)
- Focus on critical checks only
- Gather team feedback

---

## Post-Release Activities

### Immediate (Week of Release)

1. **Monitor CI/CD**
   - Watch first few PRs through pipeline
   - Gather developer feedback
   - Fix any workflow issues quickly

2. **Verify Email Testing**
   - Confirm tests are reliable
   - No flaky test failures
   - Team understands Ethereal usage

3. **Security Verification**
   - Confirm no vulnerabilities
   - Monitor for new advisories
   - Schedule next audit (1 month)

### Follow-up (Within 2 Weeks)

1. **Team Retrospective**
   - What worked well?
   - What didn't work?
   - Process improvements?

2. **Documentation Review**
   - Are docs clear and helpful?
   - Missing information?
   - Update based on feedback

3. **Plan V2.4.0**
   - Frontend Quality Sprint
   - Based on learnings from V2.3.0

---

## Appendix

### A. Pre-commit Hook Configuration

```javascript
// package.json (root)
{
  "husky": {
    "hooks": {
      "pre-commit": "lint-staged",
      "pre-push": "npm test"
    }
  },
  "lint-staged": {
    "*.{js,jsx}": [
      "eslint --fix",
      "prettier --write"
    ],
    "*.{json,md}": [
      "prettier --write"
    ]
  }
}
```

### B. Dependency Update Checklist

```markdown
## Dependency Update Checklist

For each dependency:

- [ ] Check current version: `npm list packagename`
- [ ] Check latest version: `npm show packagename version`
- [ ] Review changelog for breaking changes
- [ ] Update: `npm update packagename --save`
- [ ] Run tests: `npm test`
- [ ] Run integration tests: `npm run test:integration`
- [ ] Manual smoke test if needed
- [ ] Commit: `git commit -m "chore: update packagename to vX.Y.Z"`
- [ ] Document any breaking changes
```

### C. Email Testing Examples

```javascript
// __tests__/integration/email-service.test.js
describe('Email Service - Ethereal', () => {
  let transporter;
  
  beforeAll(async () => {
    transporter = await createTestTransporter();
  });
  
  it('should send password reset email', async () => {
    const info = await emailService.sendPasswordResetEmail(
      'test@example.com',
      'testuser',
      'RESET123',
      transporter
    );
    
    expect(info.messageId).toBeDefined();
    
    // Get preview URL
    const previewUrl = nodemailer.getTestMessageUrl(info);
    console.log('View email at:', previewUrl);
    
    // Verify email was queued
    expect(info.accepted).toContain('test@example.com');
  });
});
```

---

**Document Version**: 1.0  
**Created**: February 17, 2026  
**Target Release**: March 3, 2026  
**Maintained By**: Development Team

**Status**: ðŸ“‹ Ready for Implementation