# V2.2.5 - Import System Completion

**Version**: 2.2.5  
**Release Type**: Patch (Bug Fixes + Improvements)  
**Timeline**: 2-3 days  
**Target Date**: February 20, 2026  
**Status**: ðŸš§ In Progress

---

## Executive Summary

V2.2.5 completes the import system by fixing the remaining 12 failing tests in `import-backup.test.js`. These tests expose real issues in the import functionality that need to be addressed.

### Current State
- **Passing Tests**: 9/21 (43%)
- **Failing Tests**: 12/21 (57%)
- **Overall Test Pass Rate**: 93.5% (201/215 tests)

### Target State
- **Passing Tests**: 21/21 (100%)
- **Overall Test Pass Rate**: 95%+ (213/215 tests)

---

## Failing Tests Analysis

Based on the test output, here are the 12 failing tests:

### 1. File Validation (1 test)

**Test**: `should reject non-JSON file`
**Expected**: 400 Bad Request
**Actual**: 500 Internal Server Error
**Issue**: Multer file validation error not handled properly in middleware
**Root Cause**: ImportError thrown by multer is not caught correctly

```javascript
// Current behavior
ImportError: Must be .json file
  at fileFilter (importController.js:36:9)
  at wrappedFileFilter (multer/index.js:44:7)

// Error becomes unhandled and returns 500
```

**Fix Required**:
- Add proper error handling for MulterError
- Return 400 instead of 500 for file validation errors

---

### 2. Merge Mode (3 tests)

**Test 1**: `should successfully import backup in merge mode`
**Expected**: 200 OK
**Actual**: 422 Unprocessable Entity
**Issue**: Validation error - recipe schema validation failing

**Test 2**: `should skip duplicates in merge mode`
**Error**: `ValidationError: Recipe validation failed: ingredients.0.name: Path 'name' is required`
**Issue**: Test data uses old ingredient schema (`item`) instead of new schema (`name`)

**Test 3**: `should preserve existing data in merge mode`
**Error**: Same validation error
**Issue**: Same schema mismatch

**Fix Required**:
- Update test data to use correct schema (`name` not `item`)
- Or add backward compatibility in import processor

---

### 3. Replace Mode (3 tests)

**Test 1**: `should reject replace mode without password`
**Expected**: 400 Bad Request
**Actual**: 401 Unauthorized
**Issue**: Password validation returns wrong status code

**Test 2**: `should reject replace mode with wrong password`
**Expected**: 400 Bad Request (with INVALID_PASSWORD code)
**Actual**: 500 Internal Server Error
**Issue**: `TypeError: Cannot read properties of null (reading 'comparePassword')`

```javascript
// importController.js:84
const isPasswordValid = await user.comparePassword(password);
// user is null when not found
```

**Test 3**: `should delete all existing data in replace mode`
**Error**: `ValidationError: ingredients.0.name: Path 'name' is required`
**Issue**: Same schema issue as merge mode tests

**Fix Required**:
- Check if user exists before calling comparePassword
- Return 400 for password validation errors (not 401)
- Fix ingredient schema in test data

---

### 4. ID Remapping (3 tests)

**Test 1**: `should remap recipe IDs in collections`
**Expected**: 200 OK
**Actual**: 422 Unprocessable Entity
**Issue**: Recipe validation failing (schema issue)

**Test 2**: `should remap recipe IDs in meal plans`
**Expected**: 200 OK
**Actual**: 422 Unprocessable Entity
**Issue**: Same validation error

**Test 3**: `should handle missing recipe references gracefully`
**Expected**: 200 OK
**Actual**: 422 Unprocessable Entity
**Issue**: Validation error prevents import from completing

**Fix Required**:
- Fix ingredient schema in test data
- Ensure ID remapping handles validation errors gracefully

---

### 5. Transaction Rollback (1 test)

**Test**: `should rollback on validation error`
**Expected**: 400 Bad Request
**Actual**: 422 Unprocessable Entity
**Issue**: Status code mismatch - test expects 400 but API returns 422

**Fix Required**:
- Update test expectation to 422 (correct for validation errors)
- This is a test fix, not code fix

---

### 6. Security (1 test)

**Test**: `should sanitize XSS in recipe titles`
**Error**: `TypeError: Cannot read properties of null (reading 'title')`
**Issue**: Recipe not imported due to validation error

**Fix Required**:
- Fix ingredient schema so recipe imports successfully
- Then verify XSS sanitization works

---

## Implementation Plan

### Phase 1: Fix Multer Error Handling (2 hours)

**File**: `backend/src/controllers/importController.js`

**Changes Needed**:

```javascript
// Add MulterError handling
const multer = require('multer');

// In importBackup function
exports.importBackup = async (req, res) => {
  try {
    // ... existing code
  } catch (error) {
    // Add at beginning of catch block
    if (error.name === 'MulterError' || error instanceof multer.MulterError) {
      return res.status(400).json({
        success: false,
        error: 'File upload error',
        details: { message: error.message }
      });
    }
    
    if (error.message === 'Must be .json file') {
      return res.status(400).json({
        success: false,
        error: 'Invalid file type',
        details: { message: error.message }
      });
    }
    
    // ... existing error handling
  }
};
```

**Tests Fixed**: 1 test (file validation)

---

### Phase 2: Fix Ingredient Schema Issues (3 hours)

**Option A**: Update test data (simpler, faster)

**File**: `backend/src/__tests__/integration/import-backup.test.js`

Find all test data and replace:
```javascript
// OLD
ingredients: [
  { item: 'Flour', quantity: 2, unit: 'cups' }
]

// NEW
ingredients: [
  { name: 'Flour', quantity: 2, unit: 'cups' }
]
```

**Option B**: Add backward compatibility (more robust)

**File**: `backend/src/services/importProcessor.js`

```javascript
// Migrate old schema to new
function migrateIngredientSchema(recipe) {
  if (recipe.ingredients) {
    recipe.ingredients = recipe.ingredients.map(ing => {
      if (ing.item && !ing.name) {
        return { ...ing, name: ing.item, item: undefined };
      }
      return ing;
    });
  }
  return recipe;
}

// Apply in import process
recipes = recipes.map(recipe => migrateIngredientSchema(recipe));
```

**Recommendation**: Use **Option A** (update test data)
- Simpler and faster
- Tests should use current schema
- Backward compat can be added later if needed

**Tests Fixed**: 8 tests (merge mode, replace mode, ID remapping, XSS)

---

### Phase 3: Fix Password Validation (1 hour)

**File**: `backend/src/controllers/importController.js`

**Current Code** (line ~84):
```javascript
const isPasswordValid = await user.comparePassword(password);
if (!isPasswordValid) {
  return res.status(401).json({ 
    success: false, 
    error: 'Invalid password' 
  });
}
```

**Fixed Code**:
```javascript
// Add null check
if (!user) {
  return res.status(400).json({
    success: false,
    error: 'Password  verification failed',
    details: { code: 'INVALID_PASSWORD' }
  });
}

const isPasswordValid = await user.comparePassword(password);
if (!isPasswordValid) {
  return res.status(400).json({  // Changed from 401 to 400
    success: false,
    error: 'Invalid password',
    details: { code: 'INVALID_PASSWORD' }
  });
}
```

**Tests Fixed**: 2 tests (replace mode password validation)

---

### Phase 4: Fix Test Expectations (30 minutes)

**File**: `backend/src/__tests__/integration/import-backup.test.js`

**Change**:
```javascript
// Line ~542
// OLD
expect(res.status).toBe(400);

// NEW
expect(res.status).toBe(422);  // Validation errors return 422
```

**Tests Fixed**: 1 test (transaction rollback)

---

## Implementation Timeline

### Day 1 (6 hours)
- **Morning** (3 hours):
  - Phase 1: Fix Multer error handling
  - Phase 2: Start ingredient schema fixes
  
- **Afternoon** (3 hours):
  - Phase 2: Complete ingredient schema fixes
  - Run tests to verify fixes

### Day 2 (4 hours)
- **Morning** (2 hours):
  - Phase 3: Fix password validation
  - Phase 4: Fix test expectations
  
- **Afternoon** (2 hours):
  - Run full test suite
  - Fix any remaining issues
  - Verify all 21/21 tests passing

### Day 3 (2 hours)
- **Morning** (1 hour):
  - Code review
  - Update documentation
  
- **Afternoon** (1 hour):
  - Update CHANGELOG
  - Prepare release

---

## Testing Strategy

### Unit Testing
- Test each fix in isolation
- Run import-backup tests after each phase
- Verify no regressions in other tests

### Integration Testing
- Full test suite run: `npm test`
- Verify overall pass rate >95%
- Manual import testing with sample files

### Manual Testing Checklist
- [ ] Import valid backup file (merge mode)
- [ ] Import with duplicates (skip duplicates)
- [ ] Import in replace mode (with password)
- [ ] Import with invalid file type (verify 400)
- [ ] Import with validation errors (verify 422)

---

## Success Criteria

### Must Have âœ…
- [ ] All 21 import-backup tests passing (100%)
- [ ] Overall test pass rate â‰¥95% (213/215 tests)
- [ ] No new test failures introduced
- [ ] Import system fully functional

### Nice to Have ðŸŽ¯
- [ ] Backward compatibility for old ingredient schema
- [ ] Better error messages
- [ ] Import validation improvements

---

## Risk Assessment

### Low Risk ðŸŸ¢
Most fixes are straightforward:
- Test data updates (no code changes)
- Error handling improvements
- Status code corrections

### Mitigation
- Test after each change
- Keep changes minimal and focused
- Document all changes

---

## Deliverables

### Code Changes
1. `importController.js` - Error handling fixes
2. `import-backup.test.js` - Test data schema updates

### Documentation
1. CHANGELOG.md - V2.2.5 entry
2. CODE_REVIEW_V2.2.5.md - Review document
3. V2.2.5-PROGRESS.md - Progress tracking

---

## Next Steps

1. **Immediate**: Start Phase 1 (Multer error handling)
2. **After V2.2.5**: Begin V2.3.0 planning (Tech Debt Sprint)

---

**Document Version**: 1.0  
**Created**: February 17, 2026  
**Target Completion**: February 20, 2026  
**Status**: ðŸš§ Ready to Begin Implementation