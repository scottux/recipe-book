# V2.1.7 Two-Factor Authentication - Design Document

**Version**: 2.1.7  
**Status**: Draft  
**Created**: February 15, 2026  
**Author**: Development Team

---

## Table of Contents

1. [Overview](#overview)
2. [System Architecture](#system-architecture)
3. [Database Design](#database-design)
4. [API Design](#api-design)
5. [Authentication Flow](#authentication-flow)
6. [Security Architecture](#security-architecture)
7. [Frontend Architecture](#frontend-architecture)
8. [Component Design](#component-design)
9. [State Management](#state-management)
10. [Error Handling](#error-handling)
11. [Performance Considerations](#performance-considerations)

---

## Overview

### Design Goals

1. **Security First**: Implement industry-standard TOTP (RFC 6238)
2. **User-Friendly**: Make setup and usage simple and intuitive
3. **Reliable**: Ensure robust recovery mechanisms
4. **Performant**: Minimal impact on login performance
5. **Maintainable**: Clean, testable code architecture

### Key Decisions

- **TOTP over SMS**: More secure, no carrier dependency, no cost
- **Optional 2FA**: User choice, not forced (higher adoption)
- **10 Recovery Codes**: Industry standard (Google, GitHub, AWS)
- **bcrypt for Recovery Codes**: Secure hashing, proven track record
- **±1 Time Window**: 90 seconds total (30s * 3) for clock skew tolerance

---

## System Architecture

### High-Level Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                        Frontend (React)                      │
├─────────────────────────────────────────────────────────────┤
│  AccountSettings  │  Enable2FAFlow  │  TwoFactorLoginPage   │
│  - Status display │  - QR Code      │  - TOTP input         │
│  - Enable/Disable │  - Verify       │  - Recovery code      │
│  - Regenerate     │  - Save codes   │  - Error handling     │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ HTTPS/JWT
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    Backend API (Express)                     │
├─────────────────────────────────────────────────────────────┤
│              Authentication Controller                       │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  /auth/2fa/setup        - Generate secret & QR       │   │
│  │  /auth/2fa/verify-setup - Verify first code         │   │
│  │  /auth/2fa/verify       - Login verification        │   │
│  │  /auth/2fa/verify-recovery - Recovery code login    │   │
│  │  /auth/2fa/disable      - Disable 2FA               │   │
│  │  /auth/2fa/regenerate-codes - New recovery codes    │   │
│  │  /auth/2fa/status       - Get 2FA status            │   │
│  └─────────────────────────────────────────────────────┘   │
│                            │                                 │
│              ┌─────────────┴─────────────┐                  │
│              ▼                           ▼                  │
│      ┌──────────────┐           ┌──────────────┐           │
│      │   speakeasy  │           │   qrcode     │           │
│      │ (TOTP logic) │           │ (QR gen)     │           │
│      └──────────────┘           └──────────────┘           │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ Mongoose ODM
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                      MongoDB Database                        │
├─────────────────────────────────────────────────────────────┤
│  users collection:                                           │
│  {                                                           │
│    email: "user@example.com",                               │
│    password: "bcrypt_hash",                                 │
│    twoFactorEnabled: true,                                  │
│    twoFactorSecret: "BASE32_SECRET",                        │
│    twoFactorBackupCodes: [                                  │
│      { code: "bcrypt_hash", used: false, usedAt: null }     │
│    ],                                                        │
│    twoFactorEnabledAt: ISODate("..."),                      │
│    twoFactorFailedAttempts: 0,                              │
│    twoFactorLockedUntil: null                               │
│  }                                                           │
└─────────────────────────────────────────────────────────────┘
```

---

## Database Design

### User Collection Schema Updates

```javascript
// New fields added to User model
{
  // 2FA Status
  twoFactorEnabled: {
    type: Boolean,
    default: false,
    index: true  // Index for efficient filtering
  },
  
  // TOTP Secret (Base32 encoded)
  twoFactorSecret: {
    type: String,
    select: false  // CRITICAL: Never include in default queries
  },
  
  // Recovery Codes Array
  twoFactorBackupCodes: [{
    code: {
      type: String,
      required: true  // Hashed with bcrypt
    },
    used: {
      type: Boolean,
      default: false,
      index: true  // Index for finding unused codes
    },
    usedAt: {
      type: Date,
      default: null
    }
  }],
  
  // Tracking Timestamps
  twoFactorEnabledAt: Date,
  twoFactorLastDisabledAt: Date,
  twoFactorRecoveryCodesGeneratedAt: Date,
  
  // Security: Failed Attempt Tracking
  twoFactorFailedAttempts: {
    type: Number,
    default: 0
  },
  twoFactorLastFailedAttempt: Date,
  twoFactorLockedUntil: Date
}
```

### Indexes

```javascript
// Compound index for recovery code lookups
userSchema.index({ 
  'twoFactorBackupCodes.code': 1, 
  'twoFactorBackupCodes.used': 1 
});

// Index for finding users with 2FA enabled
userSchema.index({ twoFactorEnabled: 1 });

// Index for finding locked accounts
userSchema.index({ twoFactorLockedUntil: 1 });
```

### Migration Strategy

```javascript
// migrations/v2.1.7-add-2fa-fields.js
const User = require('../models/User');

async function up() {
  // Add new fields to existing users
  await User.updateMany(
    { twoFactorEnabled: { $exists: false } },
    {
      $set: {
        twoFactorEnabled: false,
        twoFactorBackupCodes: [],
        twoFactorFailedAttempts: 0
      }
    }
  );
  
  // Create indexes
  await User.collection.createIndex({ twoFactorEnabled: 1 });
  await User.collection.createIndex({ 
    'twoFactorBackupCodes.code': 1, 
    'twoFactorBackupCodes.used': 1 
  });
}

async function down() {
  // Remove 2FA fields
  await User.updateMany(
    {},
    {
      $unset: {
        twoFactorEnabled: '',
        twoFactorSecret: '',
        twoFactorBackupCodes: '',
        twoFactorEnabledAt: '',
        twoFactorLastDisabledAt: '',
        twoFactorRecoveryCodesGeneratedAt: '',
        twoFactorFailedAttempts: '',
        twoFactorLastFailedAttempt: '',
        twoFactorLockedUntil: ''
      }
    }
  );
  
  // Drop indexes
  await User.collection.dropIndex({ twoFactorEnabled: 1 });
  await User.collection.dropIndex({ 
    'twoFactorBackupCodes.code': 1, 
    'twoFactorBackupCodes.used': 1 
  });
}
```

---

## API Design

### Endpoint Structure

All 2FA endpoints are under `/api/auth/2fa/` namespace:

```
/api/auth/2fa/
├── setup               POST   (Initialize 2FA)
├── verify-setup        POST   (Complete setup)
├── verify              POST   (Login verification)
├── verify-recovery     POST   (Recovery code login)
├── disable             POST   (Disable 2FA)
├── regenerate-codes    POST   (New recovery codes)
└── status              GET    (Get 2FA status)
```

### Request/Response Patterns

#### Standard Success Response
```javascript
{
  success: true,
  data: {
    // Response payload
  },
  message: "Optional success message"  // Human-readable
}
```

#### Standard Error Response
```javascript
{
  success: false,
  error: {
    code: "2FA_003",           // Machine-readable code
    message: "Invalid code",    // Short message
    details: "The code..."      // Detailed explanation
  }
}
```

### Rate Limiting Strategy

```javascript
// Different limits for different operations
const rateLimits = {
  // Setup/verification (more permissive)
  setup: {
    windowMs: 60 * 60 * 1000,  // 1 hour
    max: 3                      // 3 attempts
  },
  
  verify: {
    windowMs: 15 * 60 * 1000,  // 15 minutes
    max: 5                      // 5 attempts
  },
  
  // Management (more restrictive)
  disable: {
    windowMs: 60 * 60 * 1000,  // 1 hour
    max: 3                      // 3 attempts
  },
  
  regenerate: {
    windowMs: 24 * 60 * 60 * 1000,  // 24 hours
    max: 3                           // 3 attempts
  }
};
```

---

## Authentication Flow

### Current Login Flow (Pre-2FA)

```
┌─────────┐
│  Client │
└────┬────┘
     │
     │ 1. POST /api/auth/login
     │    { email, password }
     ▼
┌─────────────────────┐
│  validateCredentials│
│  - Check user exists│
│  - Verify password  │
└────┬────────────────┘
     │
     │ 2. Create JWT
     ▼
┌─────────────────────┐
│   Return Token      │
│   { token, user }   │
└─────────────────────┘
```

### New Login Flow (With 2FA)

```
┌─────────┐
│  Client │
└────┬────┘
     │
     │ 1. POST /api/auth/login
     │    { email, password }
     ▼
┌─────────────────────────────┐
│  validateCredentials         │
│  - Check user exists         │
│  - Verify password           │
└────┬────────────────────────┘
     │
     ├──► 2a. If 2FA NOT enabled
     │         ├── Create full JWT
     │         └── Return { token, user }
     │
     └──► 2b. If 2FA enabled
               ├── Create temp session (5 min)
               ├── Return { requiresTwoFactor: true, tempToken }
               │
               ▼
          ┌─────────────────────────────┐
          │  Frontend redirects to      │
          │  /login/two-factor          │
          └────┬────────────────────────┘
               │
               │ 3. User enters TOTP code
               │    POST /api/auth/2fa/verify
               │    { email, token }
               ▼
          ┌─────────────────────────────┐
          │  verifyTOTP                 │
          │  - Validate code            │
          │  - Check rate limit         │
          │  - Check account lock       │
          └────┬────────────────────────┘
               │
               ├──► Valid code
               │    ├── Reset failed attempts
               │    ├── Create full JWT
               │    └── Return { token, user }
               │
               └──► Invalid code
                    ├── Increment failed attempts
                    ├── Lock if >= 10 failures
                    └── Return error
```

### 2FA Setup Flow

```
┌─────────┐
│  Client │
└────┬────┘
     │
     │ 1. Click "Enable 2FA"
     │    POST /api/auth/2fa/setup
     │    { password }
     ▼
┌────────────────────────────┐
│  Verify password           │
│  Check not already enabled │
└────┬───────────────────────┘
     │
     │ 2. Generate secret
     ▼
┌────────────────────────────┐
│  speakeasy.generateSecret()│
│  - name: "RecipeBook:email"│
│  - issuer: "RecipeBook"    │
│  - length: 32              │
└────┬───────────────────────┘
     │
     │ 3. Generate QR code
     ▼
┌────────────────────────────┐
│  qrcode.toDataURL()        │
│  Input: otpauth:// URI     │
│  Output: data:image/png    │
└────┬───────────────────────┘
     │
     │ 4. Store secret (NOT enabled yet)
     │    user.twoFactorSecret = secret
     │    user.save()
     ▼
┌────────────────────────────┐
│  Return to client:         │
│  - secret (base32)         │
│  - qrCode (data URI)       │
│  - manualEntry code        │
└────┬───────────────────────┘
     │
     │ 5. User scans QR
     │    User enters first code
     │    POST /api/auth/2fa/verify-setup
     │    { token }
     ▼
┌────────────────────────────┐
│  Verify TOTP code          │
│  speakeasy.totp.verify()   │
└────┬───────────────────────┘
     │
     │ 6. Generate recovery codes
     ▼
┌────────────────────────────┐
│  generateRecoveryCodes()   │
│  - 10 codes                │
│  - crypto.randomBytes()    │
│  - bcrypt.hash() each      │
└────┬───────────────────────┘
     │
     │ 7. Enable 2FA
     ▼
┌────────────────────────────┐
│  user.twoFactorEnabled=true│
│  user.twoFactorEnabledAt   │
│  user.twoFactorBackupCodes │
│  user.save()               │
└────┬───────────────────────┘
     │
     │ 8. Send email notification
     │    Return recovery codes
     ▼
┌────────────────────────────┐
│  Client displays codes     │
│  User must save them       │
└────────────────────────────┘
```

---

## Security Architecture

### TOTP Implementation (RFC 6238)

```javascript
// Secret Generation
const speakeasy = require('speakeasy');

const secret = speakeasy.generateSecret({
  name: `RecipeBook (${user.email})`,  // Displayed in app
  issuer: 'RecipeBook',                 // App name
  length: 32                            // 160 bits (256 bits recommended)
});

// Returns:
// {
//   base32: "JBSWY3DPEHPK3PXP...",  // Store this
//   otpauth_url: "otpauth://totp/...",
//   ascii: "...",
//   hex: "..."
// }
```

```javascript
// Token Verification
const verified = speakeasy.totp.verify({
  secret: user.twoFactorSecret,
  encoding: 'base32',
  token: userInputCode,
  window: 1  // Accept ±1 time step (±30 seconds)
});

// Time Step Calculation
// T = floor((Current Unix Time - T0) / X)
// T0 = 0 (Unix epoch)
// X = 30 seconds
// window = 1 means accept T, T-1, T+1
```

### Recovery Code Generation

```javascript
async function generateRecoveryCode() {
  // 1. Generate random bytes
  const randomBytes = crypto.randomBytes(4);  // 4 bytes = 8 hex chars
  
  // 2. Convert to hex
  let hex = randomBytes.toString('hex').toUpperCase();
  
  // 3. Remove ambiguous characters
  hex = hex
    .replace(/0/g, 'A')  // Zero -> A
    .replace(/O/g, 'B')  // O -> B
    .replace(/I/g, 'C')  // I -> C
    .replace(/L/g, 'D'); // L -> D
  
  // 4. Format as XXXX-XXXX
  const formatted = `${hex.slice(0, 4)}-${hex.slice(4, 8)}`;
  
  // 5. Hash for storage
  const hashed = await bcrypt.hash(formatted, 10);
  
  return {
    plain: formatted,  // Show to user once
    hashed: hashed     // Store in database
  };
}
```

### Account Lockout Logic

```javascript
// After failed 2FA attempt
async function handleFailedAttempt(user) {
  user.twoFactorFailedAttempts += 1;
  user.twoFactorLastFailedAttempt = new Date();
  
  // Lock after 10 failures
  if (user.twoFactorFailedAttempts >= 10) {
    user.twoFactorLockedUntil = new Date(Date.now() + 15 * 60 * 1000);
    
    // Send security alert email
    await emailService.sendSecurityAlert(user.email, {
      type: '2FA_LOCKOUT',
      attempts: user.twoFactorFailedAttempts,
      lockUntil: user.twoFactorLockedUntil
    });
  }
  
  await user.save();
}

// Before allowing 2FA attempt
function isAccountLocked(user) {
  if (!user.twoFactorLockedUntil) return false;
  
  const now = new Date();
  const stillLocked = now < user.twoFactorLockedUntil;
  
  // Auto-unlock if time has passed
  if (!stillLocked) {
    user.twoFactorFailedAttempts = 0;
    user.twoFactorLockedUntil = null;
    user.twoFactorLastFailedAttempt = null;
  }
  
  return stillLocked;
}
```

### Session Management

```javascript
// Temporary session (after password, before 2FA)
const tempSession = {
  userId: user._id,
  email: user.email,
  requiresTwoFactor: true,
  expiresIn: '5m',  // 5 minutes only
  scope: ['2fa:verify']  // Can only verify 2FA
};

const tempToken = jwt.sign(tempSession, JWT_SECRET);

// Full session (after successful 2FA)
const fullSession = {
  userId: user._id,
  email: user.email,
  twoFactorVerified: true,
  expiresIn: '7d',  // Full session duration
  scope: ['*']  // Full access
};

const fullToken = jwt.sign(fullSession, JWT_SECRET);
```

---

## Frontend Architecture

### Component Hierarchy

```
App
└── AuthContext (manages 2FA state)
    ├── LoginPage
    │   └── (redirects to TwoFactorLoginPage if needed)
    │
    ├── TwoFactorLoginPage
    │   ├── TOTPInput component
    │   └── RecoveryCodeInput component
    │
    └── AccountSettingsPage
        └── TwoFactorSection
            ├── Enable2FAModal
            │   ├── Step1PasswordConfirm
            │   ├── Step2QRCodeDisplay
            │   ├── Step3VerifyCode
            │   └── Step4SaveRecoveryCodes
            │
            ├── Disable2FAModal
            └── RegenerateCodesModal
```

### API Service Layer

```javascript
// services/api.js - 2FA methods

export const twoFactorAPI = {
  // Setup
  async setup(password) {
    const response = await api.post('/auth/2fa/setup', { password });
    return response.data;
  },
  
  async verifySetup(token) {
    const response = await api.post('/auth/2fa/verify-setup', { token });
    return response.data;
  },
  
  // Login
  async verify(email, token) {
    const response = await api.post('/auth/2fa/verify', { email, token });
    return response.data;
  },
  
  async verifyRecovery(email, recoveryCode) {
    const response = await api.post('/auth/2fa/verify-recovery', { 
      email, 
      recoveryCode 
    });
    return response.data;
  },
  
  // Management
  async disable(password, token) {
    const response = await api.post('/auth/2fa/disable', { 
      password, 
      token 
    });
    return response.data;
  },
  
  async regenerateCodes(password, token) {
    const response = await api.post('/auth/2fa/regenerate-codes', { 
      password, 
      token 
    });
    return response.data;
  },
  
  async getStatus() {
    const response = await api.get('/auth/2fa/status');
    return response.data;
  }
};
```

---

## Component Design

### Enable2FAModal Component

```javascript
// State machine for setup flow
const SETUP_STEPS = {
  PASSWORD: 'password',
  QR_CODE: 'qr_code',
  VERIFY: 'verify',
  SAVE_CODES: 'save_codes'
};

const Enable2FAModal = () => {
  const [step, setStep] = useState(SETUP_STEPS.PASSWORD);
  const [password, setPassword] = useState('');
  const [secret, setSecret] = useState(null);
  const [qrCode, setQrCode] = useState(null);
  const [recoveryCodes, setRecoveryCodes] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  
  const handlePasswordSubmit = async () => {
    try {
      setLoading(true);
      const data = await twoFactorAPI.setup(password);
      setSecret(data.secret);
      setQrCode(data.qrCode);
      setStep(SETUP_STEPS.QR_CODE);
    } catch (err) {
      setError(err.message);
    } finally {
      setLoading(false);
    }
  };
  
  const handleVerifyCode = async (code) => {
    try {
      setLoading(true);
      const data = await twoFactorAPI.verifySetup(code);
      setRecoveryCodes(data.recoveryCodes);
      setStep(SETUP_STEPS.SAVE_CODES);
    } catch (err) {
      setError(err.message);
    } finally {
      setLoading(false);
    }
  };
  
  // Render based on current step
  return (
    <Modal>
      {step === SETUP_STEPS.PASSWORD && <PasswordStep />}
      {step === SETUP_STEPS.QR_CODE && <QRCodeStep />}
      {step === SETUP_STEPS.VERIFY && <VerifyStep />}
      {step === SETUP_STEPS.SAVE_CODES && <SaveCodesStep />}
    </Modal>
  );
};
```

### TwoFactorLoginPage Component

```javascript
const TwoFactorLoginPage = () => {
  const [useRecoveryCode, setUseRecoveryCode] = useState(false);
  const [code, setCode] = useState('');
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [remainingAttempts, setRemainingAttempts] = useState(5);
  
  const { email, tempToken } = useLocation().state;
  const navigate = useNavigate();
  
  const handleVerify = async () => {
    try {
      setLoading(true);
      setError(null);
      
      const data = useRecoveryCode
        ? await twoFactorAPI.verifyRecovery(email, code)
        : await twoFactorAPI.verify(email, code);
      
      // Success - store token and redirect
      localStorage.setItem('token', data.token);
      navigate('/');
      
    } catch (err) {
      setError(err.message);
      setRemainingAttempts(prev => prev - 1);
      
      if (err.code === '2FA_008') {
        // Account locked
        navigate('/login/locked');
      }
    } finally {
      setLoading(false);
    }
  };
  
  return (
    <div className="min-h-screen flex items-center justify-center bg-cookbook-cream">
      <div className="bg-cookbook-paper border-2 border-cookbook-aged shadow-card p-8">
        <h1 className="text-3xl font-display font-bold text-cookbook-darkbrown mb-4">
          Two-Factor Authentication
        </h1>
        
        {!useRecoveryCode ? (
          <TOTPInput 
            value={code}
            onChange={setCode}
            onSubmit={handleVerify}
            loading={loading}
            error={error}
            remainingAttempts={remainingAttempts}
          />
        ) : (
          <RecoveryCodeInput
            value={code}
            onChange={setCode}
            onSubmit={handleVerify}
            loading={loading}
            error={error}
          />
        )}
        
        <button
          onClick={() => setUseRecoveryCode(!useRecoveryCode)}
          className="mt-4 text-cookbook-accent hover:underline"
        >
          {useRecoveryCode 
            ? 'Use authenticator code instead'
            : 'Use recovery code instead'}
        </button>
      </div>
    </div>
  );
};
```

---

## State Management

### AuthContext Updates

```javascript
// context/AuthContext.jsx

const AuthContext = createContext();

export const AuthProvider = ({ children }) => {
  const [user, setUser] = useState(null);
  const [requires2FA, setRequires2FA] = useState(false);
  const [tempToken, setTempToken] = useState(null);
  
  const login = async (email, password) => {
    try {
      const response = await authAPI.login(email, password);
      
      if (response.requiresTwoFactor) {
        // User has 2FA enabled
        setRequires2FA(true);
        setTempToken(response.tempToken);
        return { requires2FA: true };
      } else {
        // Normal login
        setUser(response.user);
        localStorage.setItem('token', response.token);
        return { requires2FA: false };
      }
    } catch (error) {
      throw error;
    }
  };
  
  const verify2FA = async (email, code) => {
    try {
      const response = await twoFactorAPI.verify(email, code);
      setUser(response.user);
      setRequires2FA(false);
      setTempToken(null);
      localStorage.setItem('token', response.token);
    } catch (error) {
      throw error;
    }
  };
  
  return (
    <AuthContext.Provider value={{ 
      user, 
      login, 
      verify2FA,
      requires2FA,
      tempToken
    }}>
      {children}
    </AuthContext.Provider>
  );
};
```

---

## Error Handling

### Error Code Mapping

```javascript
// utils/errorMessages.js

export const ERROR_MESSAGES = {
  // 2FA specific
  '2FA_001': 'Two-factor authentication is not enabled on your account.',
  '2FA_002': 'Two-factor authentication is already enabled.',
  '2FA_003': 'Invalid verification code. Please try again.',
  '2FA_004': 'Verification code has expired. Please try again.',
  '2FA_005': 'Invalid recovery code.',
  '2FA_006': 'This recovery code has already been used.',
  '2FA_007': 'Too many failed attempts. Please try again later.',
  '2FA_008': 'Account temporarily locked due to too many failed attempts.',
  '2FA_009': 'Incorrect password.',
  '2FA_010': 'Cannot disable 2FA yet. Please wait before trying again.',
  '2FA_011': 'No recovery codes remaining. Please regenerate.',
  '2FA_012': 'Failed to generate QR code. Please try again.',
  
  // Generic fallback
  'DEFAULT': 'An error occurred. Please try again.'
};

export function getErrorMessage(errorCode) {
  return ERROR_MESSAGES[errorCode] || ERROR_MESSAGES.DEFAULT;
}
```

### Error Display Component

```javascript
const ErrorAlert = ({ error, onDismiss }) => {
  if (!error) return null;
  
  const message = typeof error === 'string' 
    ? error 
    : getErrorMessage(error.code);
  
  return (
    <div className="bg-red-50 border-2 border-red-200 text-red-700 px-4 py-3 rounded-lg font-body mb-4">
      <div className="flex items-center justify-between">
        <p>{message}</p>
        {onDismiss && (
          <button onClick={onDismiss} className="text-red-700 hover:text-red-900">
            ✕
          </button>
        )}
      </div>
    </div>
  );
};
```

---

## Performance Considerations

### Backend Optimizations

1. **Selective Field Loading**
   ```javascript
   // Don't load 2FA secret unless explicitly needed
   const user = await User.findById(userId)
     .select('+twoFactorSecret');  // Explicit select
   ```

2. **Index Usage**
   ```javascript
   // Efficient queries with compound index
   const unusedCodes = user.twoFactorBackupCodes.filter(c => !c.used);
   // Uses index: { 'twoFactorBackupCodes.used': 1 }
   ```

3. **Rate Limiting Caching**
   ```javascript
   // Use Redis for rate limiting (if available)
   // Fall back to in-memory for development
   ```

### Frontend Optimizations

1. **Code Splitting**
   ```javascript
   // Lazy load 2FA components
   const Enable2FAModal = lazy(() => import('./Enable2FAModal'));
   const TwoFactorLoginPage = lazy(() => import('./TwoFactorLoginPage'));
   ```

2. **QR Code Caching**
   ```javascript
   // Cache QR code in component state
   // Don't regenerate on every render
   const [qrCode, setQrCode] = useState(null);
   ```

3. **Debounced Input**
   ```javascript
   // Don't verify on every keystroke
   const debouncedVerify = useMemo(
     () => debounce(handleVerify, 500),
     []
   );
   ```

---

## Implementation Checklist

### Backend
- [ ] Install dependencies (speakeasy, qrcode)
- [ ] Update User model schema
- [ ] Add User model methods (generate, verify, etc.)
- [ ] Create migration script
- [ ] Implement setup endpoint
- [ ] Implement verify-setup endpoint
- [ ] Implement verify endpoint
- [ ] Implement verify-recovery endpoint
- [ ] Implement disable endpoint
- [ ] Implement regenerate-codes endpoint
- [ ] Implement status endpoint
- [ ] Add rate limiting middleware
- [ ] Add account lockout logic
- [ ] Create email templates
- [ ] Add email notifications
- [ ] Write unit tests
- [ ] Write integration tests

### Frontend
- [ ] Create TwoFactorSection component
- [ ] Create Enable2FAModal component
- [ ] Create QRCodeDisplay component
- [ ] Create VerifyCodeStep component
- [ ] Create SaveCodesStep component
- [ ] Create TwoFactorLoginPage component
- [ ] Create TOTPInput component
- [ ] Create RecoveryCodeInput component
- [ ] Create Disable2FAModal component
- [ ] Create RegenerateCodesModal component
- [ ] Add API service methods
- [ ] Update AuthContext
- [ ] Update login flow routing
- [ ] Add error handling
- [ ] Add loading states
- [ ] Apply cookbook theme
- [ ] Write component tests
- [ ] Test accessibility

### Testing
- [ ] Unit tests (User model methods)
- [ ] Integration tests (API endpoints)
- [ ] E2E tests (setup flow)
- [ ] E2E tests (login flow)
- [ ] E2E tests (recovery flow)
- [ ] Security testing
- [ ] Performance testing

### Documentation
- [ ] API documentation
- [ ] User guide
- [ ] FAQ
- [ ] Code review document

---

**Document Version**: 1.0  
**Last Updated**: February 15, 2026  
**Status**: Ready for Implementation